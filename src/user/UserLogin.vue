<script lang="ts">
// @ts-nocheck
import { defineComponent } from 'vue'
import { useUserStore, ITokenInfo } from '../store'
import UserDAL from '../user/userdal'
import Config from '../utils/config'
import message from '../utils/message'
import DebugLog from '../utils/debuglog'
import { GetSignature } from '../aliapi/utils'
import getUuid from 'uuid-by-string'
import AliHttp from "../aliapi/alihttp";
function v(e: string) {
  const t = atob(e)
  let r = t.length
  const n = new Uint8Array(r)
  while (r--) n[r] = t.charCodeAt(r)
  return new Blob([n])
}
function w(e: string) {
  return new Promise<string>(function (resolve, reject) {
    const n = v(e)
    const i = new FileReader()
    i.onloadend = function (e) {
      resolve((e?.target?.result as string | undefined) || '')
    }
    i.onerror = function (e) {
      return reject(e)
    }
    i.readAsText(n, 'gbk')
  })
}

function getStatusTranslation(status: string): string {
  switch (status) {
    case 'WaitLogin':
      return '等待登录'
    case 'ScanSuccess':
      return '扫码成功'
    case 'LoginSuccess':
      return '登录成功'
    case 'QRCodeExpired':
      return '二维码超时'
    default:
      return status
  }
}

export default defineComponent({
  setup() {
    const handleOpen = () => {
      setTimeout(() => {
        const webview = document.getElementById('loginiframe') as any
        if (!webview) {
          message.error('严重错误：无法打开登录弹窗，请退出小白羊后重新运行')
          return
        }
        webview.openDevTools({ mode: 'bottom', activate: false })
        // webview.openDevTools({ mode: 'detach', activate: false })
        webview.loadURL(Config.loginUrl, { httpReferrer: 'https://www.aliyundrive.com/' })

        webview.addEventListener('did-fail-load', () => {
          console.log('did-fail-load')
          const loading = document.getElementById('loginframedivloading')
          if (loading) loading.parentNode!.removeChild(loading)
          document.getElementById('loginframediverror')!.style.display = ''
        })

        webview.addEventListener('console-message', async (e: any) => {
            const msg = e.message || ''
            console.log("console-message", msg)
            // console.log('Guest page logged a message:', e.message)
            const loading = document.getElementById('loginframedivloading')
            if (loading) loading.parentNode!.removeChild(loading)
            document.getElementById('loginframediverror')!.style.display = 'none'
            if (msg.indexOf('bizExt') > 0) {
              const resp = await AliHttp.PostWithOutUserId(Config.tmpQrCodeUrl, { })
              if (AliHttp.IsSuccess(resp.code)) {
                const qrCodeUrl = resp.body.qrCodeUrl
                const codeStatusUrl = qrCodeUrl + '/status'
                const qrCodeStatus = document.getElementById('qr-code-status') as any
                webview.loadURL(qrCodeUrl)
                webview.addEventListener('did-stop-loading', () => {
                  const loading = document.getElementById('loginframedivloading')
                  if (loading) loading.parentNode!.removeChild(loading)
                  document.getElementById('loginframediverror')!.style.display = 'none'

                  // Start polling QR code status
                  const intervalId = setInterval(async () => {
                    const statusResp = await AliHttp.GetWithOutUserId(codeStatusUrl)
                    if (AliHttp.IsSuccess(statusResp.code)) {
                      const status = getStatusTranslation(statusResp.body.status)
                      const qrCodeLink = document.createElement('a');
                      qrCodeLink.href = qrCodeUrl;
                      qrCodeLink.textContent = qrCodeUrl;
                      qrCodeStatus.textContent = `二维码状态: ${status}。 如无法跳转，点击二维码链接`
                      qrCodeStatus.appendChild(qrCodeLink);
                      qrCodeLink.addEventListener('click', async (event) => {
                        event.preventDefault();
                        require('electron').shell.openExternal(qrCodeUrl);
                        while(true) {
                          const statusResp = await AliHttp.GetWithOutUserId(codeStatusUrl)
                          if (AliHttp.IsSuccess(statusResp.code) && statusResp.body.status === 'LoginSuccess') {
                            loginbizExt(msg, statusResp.body.authCode)
                            break
                          }
                        }
                      });
                      if (statusResp.body.status === 'QRCodeExpired') {
                        console.log("检测到二维码状态过期，重新刷新")
                        clearInterval(intervalId)
                        const resp = await AliHttp.PostWithOutUserId(Config.qrCodeLoginUrl, {})
                        if (AliHttp.IsSuccess(resp.code)) {
                          const qrCodeUrl = resp.body.qrCodeUrl
                          webview.loadURL(qrCodeUrl)
                        }
                      }
                      if (statusResp.body.status === 'LoginSuccess') {
                        clearInterval(intervalId)
                        loginbizExt(msg, statusResp.body.authCode)
                      }
                    } else {
                      message.error('获取二维码状态出错，请退出小白羊后重新运行')
                    }
                  }, 1000)
                })
              } else if(resp.code === 429) {
                  message.error('1个小时超过10次请求会被限流，请更换IP或者1个小时后重试')
              } else {
                  message.error('获取二维码出错，请退出小白羊后重新运行')
              }
            }
        })
      }, 500)
    }

    let isRunning = false;

    function loginbizExt(msg: string, authCode: string) {
      if (!isRunning) {
        isRunning = true
        let data = { bizExt: '' }
        try {
          data = JSON.parse(msg)
        } catch {}
        if (!data.bizExt) {
          DebugLog.mSaveDanger('登录失败：' + msg)
          return
        }
        // 构造请求体
        const requestBody = {
          code: authCode,
          grant_type: 'authorization_code',
          client_secret: '',
          client_id: ''
        }

        // 发送请求获取访问令牌
        w(data.bizExt).then(async (jsonstr: string) => {
          try {
            const result = JSON.parse(jsonstr).pds_login_result
            const tk = UserDAL.GetUserToken(result.userId)
            const deviceId = getUuid(result.userId.toString(), 5)
            const { signature } = GetSignature(0, result.userId.toString(), deviceId)
            fetch(Config.tokenUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              }, body: JSON.stringify(requestBody),
            })
            .then(response => response.json()).then(dataV2 => {
              const accessTokenV2 = dataV2.access_token;
              const refreshTokenV2 = dataV2.refresh_token;
              const expiresInV2 = dataV2.expires_in;
              const tokenTypeV2 = dataV2.token_type;
              const tk2: ITokenInfo = {
                tokenfrom: 'account',
                access_token: result.accessToken,
                refresh_token: result.refreshToken,
                expires_in: Date.now() + result.expiresIn * 1000,
                token_type: result.tokenType,
                access_token_v2: accessTokenV2,
                refresh_token_v2: refreshTokenV2,
                expires_in_v2: Date.now() + expiresInV2 * 1000,
                token_type_v2: tokenTypeV2,
                user_id: result.userId,
                user_name: result.userName,
                avatar: result.avatar,
                nick_name: result.nickName,
                default_drive_id: result.defaultDriveId,
                default_sbox_drive_id: '',
                role: result.role,
                status: result.status,
                expire_time: result.expireTime,
                state: result.state,
                pin_setup: result.dataPinSetup,
                is_first_login: result.isFirstLogin,
                need_rp_verify: result.needRpVerify,
                name: '',
                spu_id: '',
                vipIcon: '',
                is_expires: false,
                used_size: 0,
                total_size: 0,
                spaceinfo: '',
                pic_drive_id: '',
                vipname: '',
                vipexpire: '',
                device_id: deviceId,
                signature: signature,
                signInfo: {
                  signMon: -1,
                  signDay: -1
                }
              }
              console.log(tk2)
              UserDAL.UserLogin(tk2, true).then(() => {
                useUserStore().userShowLogin = false
                if (window.WebClearCookies) window.WebClearCookies({
                  origin: 'https://auth.aliyundrive.com',
                  storages: ['cookies', 'localstorage']
                })
              }).catch(() => {
                useUserStore().userShowLogin = false
                if (window.WebClearCookies) window.WebClearCookies({
                  origin: 'https://auth.aliyundrive.com',
                  storages: ['cookies', 'localstorage']
                })
              }).finally(() => {
                isRunning = false;
              })
            })
          } catch (err: any) {
            message.error('登录失败：' + (err.message || '解析失败'))
            DebugLog.mSaveDanger('登录失败：' + (err.message || '解析失败'), JSON.stringify(err))
          }
        })
      } else {
        console.log('正在登录中')
      }
    }
    // function loginbizExt(msg: string, refreshTokenV2:string) {
    //     let data = { bizExt: '' }
    //     try {
    //         data = JSON.parse(msg)
    //     } catch {}
    //     if (!data.bizExt) {
    //         DebugLog.mSaveDanger('登录失败：' + msg)
    //         return
    //     }
    //     w(data.bizExt).then((jsonstr: string) => {
    //         try {
    //             const result = JSON.parse(jsonstr).pds_login_result
    //             const deviceId = getUuid(result.userId.toString(), 5)
    //             const { signature } = GetSignature(0, result.userId.toString(), deviceId)
    //             const tk2: ITokenInfo = {
    //                 tokenfrom: 'account' ,
    //                 access_token: result.accessToken,
    //                 refresh_token: result.refreshToken,
    //                 expires_in: result.expiresIn,
    //                 token_type: result.tokenType,
    //                 access_token_v2: '',
    //                 refresh_token_v2: refreshTokenV2,
    //                 expires_in_v2: 7200,
    //                 token_type_v2: "Bearer",
    //                 user_id: result.userId,
    //                 user_name: result.userName,
    //                 avatar: result.avatar,
    //                 nick_name: result.nickName,
    //                 default_drive_id: result.defaultDriveId,
    //                 default_sbox_drive_id: '' ,
    //                 role: result.role,
    //                 status: result.status,
    //                 expire_time: result.expireTime,
    //                 state: result.state,
    //                 pin_setup: result.dataPinSetup,
    //                 is_first_login: result.isFirstLogin,
    //                 need_rp_verify: result.needRpVerify,
    //                 name: '',
    //                 spu_id: '',
    //                 is_expires: false,
    //                 used_size: 0,
    //                 total_size: 0,
    //                 spaceinfo: '',
    //                 pic_drive_id: '',
    //                 vipname: '',
    //                 vipexpire: '',
    //                 device_id: deviceId,
    //                 signature: signature
    //             }
    //             const postData = {
    //                 refresh_token: refreshTokenV2,
    //                 grant_type: 'refresh_token'
    //             }
    //             AliHttp._Post(Config.tmpUrl, postData, '', '').then(response => {
    //               if (AliHttp.IsSuccess(response.code)) {
    //                 tk2.access_token_v2 = response.body.access_token
    //                 tk2.expires_in_v2 = response.body.expires_in
    //                 tk2.token_type_v2 = response.body.token_type
    //                 UserDAL.UserLogin(tk2)
    //                   .then(() => {
    //                     useUserStore().userShowLogin = false
    //                     if (window.WebClearCookies) window.WebClearCookies({ origin: 'https://auth.aliyundrive.com', storages: ['cookies', 'localstorage'] })
    //                   })
    //                   .catch(() => {
    //                     useUserStore().userShowLogin = false
    //                     if (window.WebClearCookies) window.WebClearCookies({ origin: 'https://auth.aliyundrive.com', storages: ['cookies', 'localstorage'] })
    //                   })
    //               }
    //             }).catch (() => {
    //               message.error("refresh token刷新失败，请稍后重试")
    //               DebugLog.mSaveDanger("refresh token刷新失败，请稍后重试")
    //             })
    //         } catch (err: any) {
    //             message.error('登录失败：' + (err.message || '解析失败'))
    //             DebugLog.mSaveDanger('登录失败：' + (err.message || '解析失败'), JSON.stringify(err))
    //         }
    //     })
    // }

    const useUser = useUserStore()
    return { useUser, handleOpen }
  }
})
</script>

<template>
  <a-modal v-model:visible="useUser.userShowLogin" :mask-closable="false" unmount-on-close :footer="false" class="userloginmodal" @before-open="handleOpen">
    <template #title> 登录阿里云盘(登录两遍) </template>
    <div id="logindiv">
      <div class="logincontent">
        <div class="loginframe">
          <div id="loginframedivloading">
            <div class="ant-spin ant-spin-spinning" style="width: 100%; text-align: center">
              <div class="shaloubg"></div>
            </div>
          </div>
          <div id="loginframediverror">
            <a-row align="stretch">
              <a-col flex="none">
                <a-avatar :size="36"><i class="iconfont iconwifi" style="font-size: 24px" /></a-avatar>
              </a-col>
              <a-col flex="auto">
                <p style="font-size: 13px; margin: 0; text-align: left">
                  如果显示空白页面？请先确认你能够上网
                  <br />
                  然后关闭弹窗，重试
                </p>
              </a-col>
            </a-row>
          </div>
          <div id="loginframediv" style="overflow: hidden; position: relative; width: 100%; height: 100%">
            <Webview id="loginiframe" src="about:blank" style="width: 100%; height: 430px; border: none; overflow: hidden" />
            <div id="qr-code-status" style="bottom: 0; left: 0; right: 0; text-align: center; font-size: 10px; background-color: #fff; color: red;"></div>
          </div>

        </div>

      </div>
    </div>
  </a-modal>
</template>
<style>
#logindiv {
  min-height: 430px;
  height: calc(100%);
  text-align: center;
}
.logincontent {
  position: relative;
  margin: 0 auto;
  min-height: 430px;
}
#loginframedivloading {
  min-height: 60px;
}
.loginframe {
  top: 0;
  position: relative;
  width: 430px;
  height: 430px;
  min-height: 430px;
  margin: 0 auto;
  overflow: hidden;
  text-align: center;
}
#qr-code-status {
  position: absolute;
  bottom: 0;
  left: 0;
  background-color: white;
}
#loginframediverror {
  position: absolute;
  top: 0;
  right: 0;
  left: 0;
  z-index: 199;
  min-height: 44px;
  padding: 6px 16px;
  color: #ffffff;
  background-color: rgb(223, 86, 89);
  border-radius: 4px;
  opacity: 0.8;
}
#loginframediverror .ant-avatar {
  margin-top: 3px;
  margin-right: 16px;
  color: rgb(223, 86, 89);
  background: #ffffff;
}

.userloginmodal .arco-modal-body {
  min-height: 400px;
  padding: 0 16px 16px 16px !important;
}
.shaloubg {
  width: 60px;
  height: 60px;
  margin: 130px auto 0 auto;
}
.shaloubg::before {
  content: url("data:image/svg+xml,%3Csvg width='3em' height='3em' viewBox='0 0 100 100' preserveAspectRatio='xMidYMid' xmlns='http://www.w3.org/2000/svg'%3E%3Cg%3E%3Cpath fill='none' stroke='%23637dff' stroke-width='5' stroke-miterlimit='10' d='M58.4 51.7c-.9-.9-1.4-2-1.4-2.3s.5-.4 1.4-1.4C70.8 43.8 79.8 30.5 80 15.5H20c.2 15 9.2 28.1 21.6 32.3.9.9 1.4 1.2 1.4 1.5s-.5 1.6-1.4 2.5C29.2 56.1 20.2 69.5 20 85.5h60c-.2-16-9.2-29.6-21.6-33.8z'/%3E%3CclipPath id='a'%3E%3Cpath d='M15 20h70v25H15z'%3E%3Canimate attributeName='height' from='25' to='0' dur='1s' repeatCount='indefinite' values='25;0;0' keyTimes='0;0.5;1'/%3E%3Canimate attributeName='y' from='20' to='45' dur='1s' repeatCount='indefinite' values='20;45;45' keyTimes='0;0.5;1'/%3E%3C/path%3E%3C/clipPath%3E%3CclipPath id='b'%3E%3Cpath d='M15 55h70v25H15z'%3E%3Canimate attributeName='height' from='0' to='25' dur='1s' repeatCount='indefinite' values='0;25;25' keyTimes='0;0.5;1'/%3E%3Canimate attributeName='y' from='80' to='55' dur='1s' repeatCount='indefinite' values='80;55;55' keyTimes='0;0.5;1'/%3E%3C/path%3E%3C/clipPath%3E%3Cpath d='M29 23c3.1 11.4 11.3 19.5 21 19.5S67.9 34.4 71 23H29z' clip-path='url(%23a)' fill='%23637dff'/%3E%3Cpath d='M71.6 78c-3-11.6-11.5-20-21.5-20s-18.5 8.4-21.5 20h43z' clip-path='url(%23b)' fill='%23637dff'/%3E%3CanimateTransform attributeName='transform' type='rotate' from='0 50 50' to='180 50 50' repeatCount='indefinite' dur='1s' values='0 50 50;0 50 50;180 50 50' keyTimes='0;0.7;1'/%3E%3C/g%3E%3C/svg%3E");
}
</style>
